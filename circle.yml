machine:
  environment:
    PATH: /home/ubuntu/miniconda/bin:$PATH

dependencies:

  # Various dependencies
  pre:
    # from scikit-learn contrib
    - sudo -E apt-get -yq remove texlive-binaries --purge
    - sudo -E apt-get -yq update
    - sudo -E apt-get -yq --no-install-suggests --no-install-recommends --force-yes install dvipng texlive-latex-base texlive-latex-extra
    # Conda installation
    - wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh
    - bash ~/miniconda.sh -b -p $HOME/miniconda
    - conda update --yes conda
    - conda create -n testenv --yes python=3.6 pip wheel nose gcc swig

  # The --user is needed to let sphinx see the source and the binaries
  # The pipefail is requested to propagate exit code
  override:
    - python setup.py clean
    - python setup.py develop
    - set -o pipefail && cd doc && make html 2>&1 | tee ~/log.txt
test:
  # Grep error on the documentation
  override:
    - cat ~/log.txt && if grep -q "Traceback (most recent call last):" ~/log.txt; then false; else true; fi
deployment:
  master:
    branch: master
    commands:
      - bash ci_scripts/push_doc.sh 'stable'
  development:
    branch: development
    commands:
      - bash ci_scripts/push_doc.sh 'dev'
general:
  # Open the doc to the API
  artifacts:
    - "doc/_build/html"
    - "~/log.txt"
  # Restric the build to the branch master only
  #branches:
  #  only:
  #     - development
  #     - master
